/*! backbone-pouch - v1.3.0 - 2013-10-18
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2013 Johannes J. Schmidt; Licensed MIT */
(function(t){"use strict";function e(){for(var t={},n=0;arguments.length>n;n++){var o=arguments[n];if("object"==typeof o)for(var r in o)t[r]="object"==typeof o[r]&&"object"==typeof t[r]?e(t[r]||{},o[r]):o[r]}return t}var n;n="object"==typeof exports?exports:t.BackbonePouch={};var o=t._;o||"function"!=typeof require||(o=require("underscore"));var r={create:"post",update:"put",patch:"put","delete":"remove"};n.defaults={fetch:"allDocs",listen:!1,options:{post:{},put:{},get:{},remove:{},allDocs:{},query:{},spatial:{},changes:{continuous:!0}}},n.sync=function(t){t=t||{},t=e(n.defaults,t);var i=function(n,i,c){function s(t,e){return t?c.error&&c.error(t):(("create"===n||"update"===n||"patch"===n)&&(e={_id:e.id,_rev:e.rev}),"delete"===n&&(e={}),"read"===n&&c.listen&&c.db.info(function(t,e){c.db.changes(o.extend({},c.options.changes,{since:e.update_seq,onChange:function(t){var e=i.get(t.id);t.deleted?e&&e.destroy():e?e.set(t.doc):i.add(t.doc),"function"==typeof c.options.changes.onChange&&c.options.changes.onChange(t)}}))}),c.success&&c.success(e))}if(c=c||{},c=e(t,i&&i.pouch||{},c),"string"!=typeof n)return c;if(!c.db)throw Error('A "db" property must be specified');if(i.trigger("request",i,c.db,c),"read"===n){if(i.id)return c.db.get(i.id,c.options.get,s);if("query"===c.fetch||"spatial"===c.fetch){if(!c.options[c.fetch].fun)throw Error('A "'+c.fetch+'.fun" object must be specified');return c.db[c.fetch](c.options[c.fetch].fun,c.options[c.fetch],s)}c.db[c.fetch](c.options[c.fetch],s)}else c.db[r[n]](i.toJSON(),c.options[r[n]],s);return c};return i.defaults=t,i},n.attachments=function(t){function e(e){if(e.pouch&&e.pouch.db)return e.pouch.db;if(e.collection&&e.collection.pouch&&e.collection.pouch.db)return e.collection.pouch.db;if(t.db)return t.db;var n=e.sync();if(n.db)return n.db;throw Error('A "db" property must be specified')}return t=t||{},{attachments:function(t){var e=this.get("_attachments")||{};return t?o.filter(o.keys(e),function(n){return"function"==typeof t?t(n,e[n]):e[n].content_type.match(t)}):o.keys(e)},attachment:function(t,n){var o=e(this);return o.getAttachment(this.id,t,n)},attach:function(t,n,o,r){"function"==typeof n&&(r=n,n=void 0,o=void 0),"function"==typeof o&&(r=o,o=void 0),n=n||t.filename,o=o||t.type,this.id||this.set({_id:Math.uuid()},{silent:!0});var i=e(this),c=this;return i.putAttachment(this.id,n,this.get("_rev"),t,o,function(t,e){if(!t&&e.rev){var i=c.get("_attachments")||{};i[n]={content_type:o,stub:!0},c.set({_rev:e.rev,_attachments:i},{silent:!0})}r(t,e)})}}}})(this);